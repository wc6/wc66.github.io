<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="13. Ansible文件管理模块及Jinja2过滤器"><meta name="keywords" content="ansible,集群管理"><meta name="author" content="蝶影双双"><meta name="copyright" content="蝶影双双"><meta name="theme-color" content="#0078E7"><title>13. Ansible文件管理模块及Jinja2过滤器 | 蝶影双双的小镇</title><link rel="shortcut icon" href="/wc_favicon.ico"><link rel="mask-icon" href="/wc_favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    window.CONFIG = {"root":"/","title":"蝶影双双的小镇","version":"0.7.0","anonymous_image":"https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;family=Source+Code+Pro&amp;display=swap" media="none" onload="this.media='all'"><script src="//at.alicdn.com/t/font_1140697_rtqh36oinzl.js" async></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><link rel="preconnect" href="https://stats.g.doubleclick.net" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=UA-167189784-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-167189784-1');</script><script data-ad-client="ca-pub-6473747881546586" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><style>.google-auto-placed {
  overflow: auto;
}</style><div class="js-Pjax"></div><meta name="generator" content="Hexo 4.2.1"></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle sidebar-toggle-fixed hty-icon-button"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><aside class="sidebar"><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about" title="蝶影双双"><img width="96" loading="lazy" src="/wc.jpg" alt="蝶影双双"></a><div class="site-author-name"><a href="/about/">蝶影双双</a></div><a class="site-name" href="/about/site.html">蝶影双双的小镇</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="我的主页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item site-state-posts"><a href="/archives" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">31</span></a></div><div class="site-state-item site-state-categories"><a href="/categories" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item site-state-tags"><a href="/tags" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">12</span></a></div><a class="site-state-item hty-icon-button" href="https://www.baidu.com" target="_blank" rel="noopener" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=3180573630&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/wc6" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:666wc6@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=296185253" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/320721469" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div></div><script defer src="/js/sidebar.js"></script><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#13-Ansible文件管理模块及Jinja2过滤器"><span class="toc-number">1.</span> <span class="toc-text">13. Ansible文件管理模块及Jinja2过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#常用文件管理模块"><span class="toc-number">1.1.</span> <span class="toc-text">常用文件管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-file"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-synchronize"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. synchronize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-copy"><span class="toc-number">1.1.3.</span> <span class="toc-text">3. copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-fetch"><span class="toc-number">1.1.4.</span> <span class="toc-text">4. fetch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-lineinfile"><span class="toc-number">1.1.5.</span> <span class="toc-text">5. lineinfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-stat"><span class="toc-number">1.1.6.</span> <span class="toc-text">6. stat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-blockinfile"><span class="toc-number">1.1.7.</span> <span class="toc-text">7. blockinfile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jinja2模板管理"><span class="toc-number">1.2.</span> <span class="toc-text">Jinja2模板管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jinja2简介"><span class="toc-number">1.2.1.</span> <span class="toc-text">Jinja2简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在playbook中使用jinja2"><span class="toc-number">1.2.2.</span> <span class="toc-text">在playbook中使用jinja2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jinja2条件语句"><span class="toc-number">1.2.3.</span> <span class="toc-text">Jinja2条件语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jinja2循环语句"><span class="toc-number">1.2.4.</span> <span class="toc-text">Jinja2循环语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jinja2过滤器"><span class="toc-number">1.2.5.</span> <span class="toc-text">Jinja2过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-default过滤器"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">1. default过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-字符串操作相关的过滤器"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">2. 字符串操作相关的过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-数字操作相关的过滤器"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">3. 数字操作相关的过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-列表操作相关的过滤器"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">4. 列表操作相关的过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-应用于注册变量的过滤器"><span class="toc-number">1.2.5.5.</span> <span class="toc-text">5. 应用于注册变量的过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-应用于文件路径的过滤器"><span class="toc-number">1.2.5.6.</span> <span class="toc-text">6. 应用于文件路径的过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-自定义过滤器"><span class="toc-number">1.2.5.7.</span> <span class="toc-text">7. 自定义过滤器</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://wc6.github.io/2020/05/20/13.%20Ansible%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%8F%8AJinja2%E8%BF%87%E6%BB%A4%E5%99%A8/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="蝶影双双"><meta itemprop="description" content="13. Ansible文件管理模块及Jinja2过滤器"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="蝶影双双的小镇"></span><header class="post-header"><h1 class="post-title" itemprop="name headline" style="color: undefined">13. Ansible文件管理模块及Jinja2过滤器</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-05-20 19:28:13" itemprop="dateCreated datePublished" datetime="2020-05-20T19:28:13+08:00">2020-05-20</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2020-05-22 22:30:36" itemprop="dateModified" datetime="2020-05-22T22:30:36+08:00">2020-05-22</time></div><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="text">学习</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E5%AD%A6%E4%B9%A0/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="text">运维</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/ansible/"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">ansible</span></a><a class="tag" href="/tags/%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">集群管理</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content post-markdown"><h1 id="13-Ansible文件管理模块及Jinja2过滤器"><a href="#13-Ansible文件管理模块及Jinja2过滤器" class="headerlink" title="13. Ansible文件管理模块及Jinja2过滤器"></a>13. Ansible文件管理模块及Jinja2过滤器</h1><p>[toc]</p>
<p>对于任何自动管理工具而言，对于文件的管理都是其绕不开的话题。同样，ansible也围绕文件管理提供了众多的模块。同时还提供了Jinja2模板语法来配置文件模板。</p>
<h2 id="常用文件管理模块"><a href="#常用文件管理模块" class="headerlink" title="常用文件管理模块"></a>常用文件管理模块</h2><h3 id="1-file"><a href="#1-file" class="headerlink" title="1. file"></a>1. file</h3><p>我们在讲ansible ad-hoc的时候，已经说过file模块，在playbook中的使用也没什么不同，下面给个简单的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: Touch a file and set permissions</span><br><span class="line">  file:</span><br><span class="line">    path: &#x2F;path&#x2F;to&#x2F;file</span><br><span class="line">    owner: user1</span><br><span class="line">    group: group1</span><br><span class="line">    mode: 0640</span><br><span class="line">    state: touch</span><br></pre></td></tr></table></figure>

<h3 id="2-synchronize"><a href="#2-synchronize" class="headerlink" title="2. synchronize"></a>2. synchronize</h3><p>synchronize模块示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: synchronize local file to remote files</span><br><span class="line">  synchronize:</span><br><span class="line">    src: file</span><br><span class="line">    dest: &#x2F;path&#x2F;to&#x2F;file</span><br></pre></td></tr></table></figure>

<h3 id="3-copy"><a href="#3-copy" class="headerlink" title="3. copy"></a>3. copy</h3><p>同样的，我们已经介绍过copy模块，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: copy a file to managed hosts</span><br><span class="line">  copy:</span><br><span class="line">    src: file</span><br><span class="line">    dest: &#x2F;path&#x2F;to&#x2F;file</span><br></pre></td></tr></table></figure>

<h3 id="4-fetch"><a href="#4-fetch" class="headerlink" title="4. fetch"></a>4. fetch</h3><p>fetch模块与copy模块正好相反，copy是把主控端的文件复制到被控端，而fetch则是把被控端的文件复制到主控端。并且在主控端指定的目录下，以被控端主机名的形式来组织目录结构。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: Use the fetch module to retrieve secure log files</span><br><span class="line">  hosts: all</span><br><span class="line">  user: ansible</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Fetch the &#x2F;var&#x2F;log&#x2F;secure log file from managed hosts</span><br><span class="line">      fetch:</span><br><span class="line">        src: &#x2F;var&#x2F;log&#x2F;secure</span><br><span class="line">        dest: secure-backups</span><br><span class="line">        flat: no</span><br></pre></td></tr></table></figure>
<p>在主控端文件存储的目录树如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># tree  secure-backups&#x2F;</span><br><span class="line">secure-backups&#x2F;</span><br><span class="line">└── 10.1.61.187</span><br><span class="line">    └── var</span><br><span class="line">        └── log</span><br><span class="line">            └── secure</span><br><span class="line"></span><br><span class="line">3 directories, 1 file</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考：<a href="https://docs.ansible.com/ansible/latest/modules/fetch_module.html#fetch-module" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/fetch_module.html#fetch-module</a></p>
</blockquote>
<h3 id="5-lineinfile"><a href="#5-lineinfile" class="headerlink" title="5. lineinfile"></a>5. lineinfile</h3><p>lineinfile是一个非常有用的模块，而且相对来说，也是用法比较复杂的模块，可直接参考《Ansible lineinfile模块》</p>
<h3 id="6-stat"><a href="#6-stat" class="headerlink" title="6. stat"></a>6. stat</h3><p>stat模块与linux中的stat命令一样，用来显示文件的状态信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- name: Verify the checksum of a file</span><br><span class="line">  stat:</span><br><span class="line">    path: &#x2F;path&#x2F;to&#x2F;file</span><br><span class="line">    checksum_algorithm: md5</span><br><span class="line">  register: result</span><br><span class="line">  </span><br><span class="line">- debug:</span><br><span class="line">    msg: &quot;The checksum of the file is &#123;&#123; result.stat.checksum &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考： <a href="https://docs.ansible.com/ansible/latest/modules/stat_module.html#stat-module" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/stat_module.html#stat-module</a></p>
</blockquote>
<h3 id="7-blockinfile"><a href="#7-blockinfile" class="headerlink" title="7. blockinfile"></a>7. blockinfile</h3><p>围绕着被标记的行插入、更新、删除一个文本块。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat files/test.html</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#cat blockinfile_ex.yml</span></span><br><span class="line">---</span><br><span class="line">- name: blockinfile module <span class="built_in">test</span></span><br><span class="line">  hosts: <span class="built_in">test</span></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy test.html to dest</span><br><span class="line">      copy:</span><br><span class="line">        src: files/test.html</span><br><span class="line">        dest: /var/www/html/test.html</span><br><span class="line">    - name: add block </span><br><span class="line">      blockinfile:</span><br><span class="line">        marker: <span class="string">"&lt;!-- &#123;mark&#125; ANSIBLE MANAGED BLOCK --&gt;"</span></span><br><span class="line">        insertafter: <span class="string">"&lt;body&gt;"</span></span><br><span class="line">        path: /var/www/html/test.html</span><br><span class="line">        block: |</span><br><span class="line">          &lt;h1&gt;Welcome to &#123;&#123; ansible_hostname &#125;&#125;&lt;/h1&gt;</span><br><span class="line">          &lt;p&gt;Last updated on &#123;&#123; ansible_date_time.iso8601 &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>执行后结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@app html]# cat test.html </span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">  &lt;&#x2F;head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">&lt;!-- BEGIN ANSIBLE MANAGED BLOCK --&gt;</span><br><span class="line">&lt;h1&gt;Welcome to app&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;Last updated on 2019-05-28T15:00:03Z&lt;&#x2F;p&gt;</span><br><span class="line">&lt;!-- END ANSIBLE MANAGED BLOCK --&gt;</span><br><span class="line">  &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多blockinfile用法参考：<a href="https://docs.ansible.com/ansible/latest/modules/blockinfile_module.html#blockinfile-module" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/blockinfile_module.html#blockinfile-module</a></p>
</blockquote>
<h2 id="Jinja2模板管理"><a href="#Jinja2模板管理" class="headerlink" title="Jinja2模板管理"></a>Jinja2模板管理</h2><h3 id="Jinja2简介"><a href="#Jinja2简介" class="headerlink" title="Jinja2简介"></a>Jinja2简介</h3><p>Jinja2是基于python的模板引擎。那么什么是模板？</p>
<p>假设说现在我们需要一次性在10台主机上安装redis，这个通过playbook现在已经很容易实现。默认情况下，所有的redis安装完成之后，我们可以统一为其分发配置文件。这个时候就面临一个问题，这些redis需要监听的地址各不相同，我们也不可能为每一个redis单独写一个配置文件。因为这些配置文件中，绝大部分的配置其实都是相同的。这个时候最好的方式其实就是用一个通用的配置文件来解决所有的问题。将所有需要修改的地方使用变量替换，如下示例中redis.conf.j2文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">supervised systemd</span><br><span class="line">pidfile /var/run/redis.pid</span><br><span class="line">port 6379</span><br><span class="line">logfile <span class="string">"/var/log/redis/redis.log"</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/redis</span><br><span class="line"></span><br><span class="line">maxmemory 1G</span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> &#123;&#123; ansible_eth0.ipv4.address &#125;&#125; 127.0.0.1</span><br><span class="line"></span><br><span class="line">timeout 300</span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line">maxclients 10000</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>


<p>那么此时，redis.conf.j2文件就是一个模板文件。<code></code>是一个fact变量，用于获取被控端ip地址以实现替换。</p>
<h3 id="在playbook中使用jinja2"><a href="#在playbook中使用jinja2" class="headerlink" title="在playbook中使用jinja2"></a>在playbook中使用jinja2</h3><p>现在我们有了一个模板文件，那么在playbook中如何来使用呢？</p>
<p>playbook使用template模块来实现模板文件的分发，其用法与copy模块基本相同，唯一的区别是，copy模块会将原文件原封不动的复制到被控端，而template会将原文件复制到被控端，并且使用变量的值将文件中的变量替换以生成完整的配置文件。</p>
<p>下面是一个完整的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># cat config_redis.yml </span><br><span class="line">- name: Configure Redis</span><br><span class="line">  hosts: test</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create redis group</span><br><span class="line">      group:</span><br><span class="line">        name: redis</span><br><span class="line">        gid: 1111</span><br><span class="line">    - name: create redis user</span><br><span class="line">      user:</span><br><span class="line">        name: redis</span><br><span class="line">        uid: 1111</span><br><span class="line">        group: redis</span><br><span class="line">    - name: defined  redismem</span><br><span class="line">      set_fact: redismem&#x3D;&quot;&#123;&#123; (ansible_memtotal_mb &#x2F;2) | int &#125;&#125;M&quot;</span><br><span class="line">    - name: install redis</span><br><span class="line">      yum:</span><br><span class="line">        name: redis</span><br><span class="line">        state: present</span><br><span class="line">    - name: create data dir</span><br><span class="line">      file:</span><br><span class="line">        path: &#x2F;data&#x2F;redis</span><br><span class="line">        state: directory</span><br><span class="line">        recurse: yes</span><br><span class="line">        owner: redis</span><br><span class="line">        group: redis</span><br><span class="line">    - name: copy redis.conf to dest</span><br><span class="line">      template:</span><br><span class="line">        src: templates&#x2F;redis.conf.j2</span><br><span class="line">        dest: &#x2F;etc&#x2F;redis.conf</span><br><span class="line">      notify:</span><br><span class="line">        - restart redis</span><br><span class="line">    - name: start redis</span><br><span class="line">      service:</span><br><span class="line">        name: redis</span><br><span class="line">        state: started</span><br><span class="line">        enabled: yes</span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart redis</span><br><span class="line">      service:</span><br><span class="line">        name: redis</span><br><span class="line">        state: restarted</span><br></pre></td></tr></table></figure>

<p>执行完成之后，我们可以看到被控端/etc/redis.conf配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis.pid</span><br><span class="line">port 6379</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line"></span><br><span class="line">maxmemory &#123;&#123; redismem &#125;&#125;</span><br><span class="line"></span><br><span class="line">bind 10.1.61.187 127.0.0.1</span><br><span class="line"></span><br><span class="line">timeout 300</span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line">maxclients 10000</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>

<p>关于template模块的更多参数说明：</p>
<ul>
<li>backup：如果原目标文件存在，则先备份目标文件</li>
<li>dest：目标文件路径</li>
<li>force：是否强制覆盖，默认为yes</li>
<li>group：目标文件属组</li>
<li>mode：目标文件的权限</li>
<li>owner：目标文件属主</li>
<li>src：源模板文件路径</li>
<li>validate：在复制之前通过命令验证目标文件，如果验证通过则复制</li>
</ul>
<h3 id="Jinja2条件语句"><a href="#Jinja2条件语句" class="headerlink" title="Jinja2条件语句"></a>Jinja2条件语句</h3><p>在上面的示例中，我们直接取了被控节点的eth0网卡的ip作为其监听地址。那么假如有些机器的网卡是bond0，这种做法就会报错。这个时候我们就需要在模板文件中定义条件语句如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis.pid</span><br><span class="line">port 6379</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line"></span><br><span class="line">maxmemory 1G</span><br><span class="line"></span><br><span class="line">&#123;% if ansible_bond0 is defined %&#125;</span><br><span class="line">bind &#123;&#123; ansible_bond0.ipv4.address &#125;&#125; 127.0.0.1</span><br><span class="line">&#123;% elif ansible_eth0 is defined %&#125;</span><br><span class="line">bind &#123;&#123; ansible_eth0.ipv4.address &#125;&#125; 127.0.0.1</span><br><span class="line">&#123;% else%&#125;</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">timeout 300</span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line">maxclients 10000</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>

<p>我们可以更进一步，让redis主从角色都可以使用该文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis.pid</span><br><span class="line">port 6379</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line"></span><br><span class="line">maxmemory 1G</span><br><span class="line"></span><br><span class="line">&#123;% if ansible_bond0 is defined %&#125;</span><br><span class="line">bind &#123;&#123; ansible_bond0.ipv4.address &#125;&#125; 127.0.0.1</span><br><span class="line">&#123;% elif ansible_eth0 is defined %&#125;</span><br><span class="line">bind &#123;&#123; ansible_eth0.ipv4.address &#125;&#125; 127.0.0.1</span><br><span class="line">&#123;% else%&#125;</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if masterip is defined %&#125;</span><br><span class="line">slaveof &#123;&#123; masterip &#125;&#125; &#123;&#123; masterport|default(6379) &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if masterpass is defined %&#125;</span><br><span class="line">masterauth &#123;&#123; masterpass &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if requirepass is defined %&#125;</span><br><span class="line">requirepass &#123;&#123; requirepass &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">timeout 300</span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line">maxclients 10000</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error no</span><br></pre></td></tr></table></figure>

<p>我们定义一个inventory如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[redis]</span><br><span class="line">10.1.61.27  masterip&#x3D;10.1.61.187 masterpass&#x3D;123456</span><br><span class="line">10.1.61.187 requirepass&#x3D;123456</span><br></pre></td></tr></table></figure>


<h3 id="Jinja2循环语句"><a href="#Jinja2循环语句" class="headerlink" title="Jinja2循环语句"></a>Jinja2循环语句</h3><p>定义一个inventory示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[proxy]</span><br><span class="line">10.1.61.195</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">10.1.61.27</span><br><span class="line">10.1.61.187</span><br></pre></td></tr></table></figure>
<p>现在把proxy主机组中的主机作为代理服务器，安装nginx做反向代理，将请求转发至后面的两台webserver，即webserver组的服务器。</p>
<p>现在我们编写一个playbook如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#cat config_nginx.conf</span><br><span class="line"></span><br><span class="line"># 还需要在ansible.cfg中开启facts缓存</span><br><span class="line">- name: gather facts</span><br><span class="line">  gather_facts: Fasle</span><br><span class="line">  hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: gather facts</span><br><span class="line">      setup:</span><br><span class="line">   </span><br><span class="line">- name: Configure Nginx</span><br><span class="line">  hosts: proxy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install nginx</span><br><span class="line">      yum:</span><br><span class="line">        name: nginx</span><br><span class="line">        state: present</span><br><span class="line">    - name: copy nginx.conf to dest</span><br><span class="line">      template:</span><br><span class="line">        src: templates&#x2F;nginx.conf.j2</span><br><span class="line">        dest: &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">      notify:</span><br><span class="line">        - restart nginx</span><br><span class="line">    - name: start nginx</span><br><span class="line">      service:</span><br><span class="line">        name: nginx</span><br><span class="line">        state: started</span><br><span class="line">        enabled: yes</span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart nginx</span><br><span class="line">      service:</span><br><span class="line">        name: nginx</span><br><span class="line">        state: restarted</span><br></pre></td></tr></table></figure>

<p>模板文件 templates/nginx.conf.j2示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"># cat nginx.conf.j2 </span><br><span class="line">user nginx;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class="line">error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;</span><br><span class="line">pid &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line">include &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 65535;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    map $http_x_forwarded_for $clientRealIP &#123;</span><br><span class="line">        &quot;&quot; $remote_addr;</span><br><span class="line">        ~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$ $firstAddr;</span><br><span class="line">    &#125;</span><br><span class="line">    log_format  real_ip &#39;&#123; &quot;datetime&quot;: &quot;$time_local&quot;, &#39;</span><br><span class="line">                        &#39;&quot;remote_addr&quot;: &quot;$remote_addr&quot;, &#39;</span><br><span class="line">                        &#39;&quot;source_addr&quot;: &quot;$clientRealIP&quot;, &#39;</span><br><span class="line">                        &#39;&quot;x_forwarded_for&quot;: &quot;$http_x_forwarded_for&quot;, &#39;</span><br><span class="line">                        &#39;&quot;request&quot;: &quot;$request_uri&quot;, &#39;</span><br><span class="line">                        &#39;&quot;status&quot;: &quot;$status&quot;, &#39;</span><br><span class="line">                        &#39;&quot;request_method&quot;: &quot;$request_method&quot;, &#39;</span><br><span class="line">                        &#39;&quot;request_length&quot;: &quot;$request_length&quot;, &#39;</span><br><span class="line">                        &#39;&quot;body_bytes_sent&quot;: &quot;$body_bytes_sent&quot;, &#39;</span><br><span class="line">                        &#39;&quot;request_time&quot;: &quot;$request_time&quot;, &#39;</span><br><span class="line">                        &#39;&quot;http_referrer&quot;: &quot;$http_referer&quot;, &#39;</span><br><span class="line">                        &#39;&quot;user_agent&quot;: &quot;$http_user_agent&quot;, &#39;</span><br><span class="line">                        &#39;&quot;upstream_addr&quot;: &quot;$upstream_addr&quot;, &#39;</span><br><span class="line">                        &#39;&quot;upstream_status&quot;: &quot;$upstream_status&quot;, &#39;</span><br><span class="line">                        &#39;&quot;upstream_http_header&quot;: &quot;$upstream_http_host&quot;,&#39;</span><br><span class="line">                        &#39;&quot;upstream_response_time&quot;: &quot;$upstream_response_time&quot;, &#39;</span><br><span class="line">                        &#39;&quot;x-req-id&quot;: &quot;$http_x_request_id&quot;, &#39;</span><br><span class="line">                        &#39;&quot;servername&quot;: &quot;$host&quot;&#39;</span><br><span class="line">                        &#39; &#125;&#39;;</span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  real_ip;</span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type        application&#x2F;octet-stream;</span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line"></span><br><span class="line">    upstream web &#123;</span><br><span class="line">    &#123;% for host in groups[&#39;webservers&#39;] %&#125;</span><br><span class="line">        &#123;% if hostvars[host][&#39;ansible_bond0&#39;][&#39;ipv4&#39;][&#39;address&#39;] is defined %&#125;</span><br><span class="line">        server &#123;&#123; hostvars[host][&#39;ansible_bond0&#39;] &#125;&#125;;</span><br><span class="line">        &#123;% elif hostvars[host][&#39;ansible_eth0&#39;] is defined %&#125;</span><br><span class="line">        server &#123;&#123; hostvars[host][&#39;ansible_eth0&#39;][&#39;ipv4&#39;][&#39;address&#39;] &#125;&#125;;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;web;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>下面再给一个域名解析服务bind的配置文件 named.conf的jinja2模板示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line"></span><br><span class="line">listen-on port 53 &#123;</span><br><span class="line">127.0.0.1;</span><br><span class="line">&#123;% for ip in ansible_all_ipv4_addresses %&#125;</span><br><span class="line">&#123;&#123; ip &#125;&#125;;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">directory &quot;&#x2F;var&#x2F;named&quot;;</span><br><span class="line">dump-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;cache_dump.db&quot;;</span><br><span class="line">statistics-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;named_stats.txt&quot;;</span><br><span class="line">memstatistics-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;named_mem_stats.txt&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">type hint;</span><br><span class="line">file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;&#x2F;etc&#x2F;named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;&#x2F;etc&#x2F;named.root.key&quot;;</span><br><span class="line"></span><br><span class="line">&#123;# Variables for zone config #&#125;</span><br><span class="line">&#123;% if &#39;authorativenames&#39; in group_names %&#125;</span><br><span class="line">&#123;% set zone_type &#x3D; &#39;master&#39; %&#125;</span><br><span class="line">&#123;% set zone_dir &#x3D; &#39;data&#39; %&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">&#123;% set zone_type &#x3D; &#39;slave&#39; %&#125;</span><br><span class="line">&#123;% set zone_dir &#x3D; &#39;slaves&#39; %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">zone &quot;internal.example.com&quot; IN &#123;</span><br><span class="line">type &#123;&#123; zone_type &#125;&#125;;</span><br><span class="line">file &quot;&#123;&#123; zone_dir &#125;&#125;&#x2F;internal.example.com&quot;;</span><br><span class="line">&#123;% if &#39;authorativenames&#39; not in group_names %&#125;</span><br><span class="line">masters &#123; 192.168.2.2; &#125;;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2过滤器"><a href="#Jinja2过滤器" class="headerlink" title="Jinja2过滤器"></a>Jinja2过滤器</h3><h4 id="1-default过滤器"><a href="#1-default过滤器" class="headerlink" title="1. default过滤器"></a>1. default过滤器</h4><p>当指定的变量不存在时，用于设定默认值</p>
<p>简单示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Host&quot;: &quot;&#123;&#123; db_host | default(&#39;lcoalhost&#39;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>复杂一点儿的实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- hosts: </span><br><span class="line">  gather_facts: false</span><br><span class="line">  vars:</span><br><span class="line">    - path: &#x2F;tmp&#x2F;test</span><br><span class="line">      mode: 0400</span><br><span class="line">    - path: &#x2F;tmp&#x2F;foo</span><br><span class="line">    - path: &#x2F;tmp&#x2F;bar</span><br><span class="line">  tasks:</span><br><span class="line">    - file:</span><br><span class="line">        path: &#123;&#123; item.path &#125;&#125;</span><br><span class="line">        state: touch</span><br><span class="line">        mode: &#123;&#123; item.mode|default(omit)&#125;&#125;</span><br><span class="line">      with_items: &quot;&#123;&#123; paths &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>


<h4 id="2-字符串操作相关的过滤器"><a href="#2-字符串操作相关的过滤器" class="headerlink" title="2. 字符串操作相关的过滤器"></a>2. 字符串操作相关的过滤器</h4><ul>
<li>upper：将所有字符串转换为大写</li>
<li>lower：将所有字符串转换为小写</li>
<li>capitalize：将字符串的首字母大写，其他字母小写</li>
<li>reverse：将字符串倒序排列</li>
<li>first：返回字符串的第一个字符</li>
<li>last：返回字符串的最后一个字符</li>
<li>trim：将字符串开头和结尾的空格去掉</li>
<li>center(30)：将字符串放在中间，并且字符串两边用空格补齐30位</li>
<li>length：返回字符串的长度，与count等价</li>
<li>list：将字符串转换为列表</li>
<li>shuffle：list将字符串转换为列表，但是顺序排列，shuffle同样将字符串转换为列表，但是会随机打乱字符串顺序</li>
</ul>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars: </span><br><span class="line">    teststr: &quot;abc123ABV&quot;</span><br><span class="line">    teststr1: &quot; abc &quot;</span><br><span class="line">    teststr2: &quot;123456789&quot;</span><br><span class="line">    teststr3: &quot;sfacb1335@#$%&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123; teststr | upper &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr | lower &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr | capitalize &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr | reverse &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr|first &#125;&#125;&quot;</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123; teststr|last &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr1 | trim &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr2 | center(30) &#125;&#125;&quot;</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123; teststr2 | length &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr3 | list &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; teststr3 | shuffle &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="3-数字操作相关的过滤器"><a href="#3-数字操作相关的过滤器" class="headerlink" title="3. 数字操作相关的过滤器"></a>3. 数字操作相关的过滤器</h4><ul>
<li>int： 将对应的值转换为整数</li>
<li>float：将对应的值转换为浮点数</li>
<li>abs：获取绝对值</li>
<li>round：小数点四舍五入</li>
<li>random：从一个给定的范围中获取随机值</li>
</ul>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars: </span><br><span class="line">    testnum: -1</span><br><span class="line">  tasks:</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123;  8+(&#39;8&#39;|int) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        # 默认情况下，如果无法完成数字转换则返回0</span><br><span class="line">        # 这里指定如果无法完成数字转换则返回6</span><br><span class="line">        msg: &quot;&#123;&#123; &#39;a&#39;|int(default&#x3D;6) &#125;&#125;&quot; </span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; &#39;8&#39;|float &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; &#39;a&#39;|float(8.88)&#39; &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testnum|abs &#125;&#125;&quot;</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123; 12.5|round &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; 3.1415926 | round(5) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        # 从0到100中随机返回一个数字</span><br><span class="line">        msg: &quot;&#123;&#123; 100|random &#125;&#125;&quot;</span><br><span class="line">    - debug: </span><br><span class="line">        # 从5到10中随机返回一个数字</span><br><span class="line">        msg: &quot;&#123;&#123; 10|random(start&#x3D;5) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        # 从4到15中随机返回一个数字，步长为3</span><br><span class="line">        # 返回的随机数只可能是：4，7，10，13中的一个</span><br><span class="line">        msg: &quot;&#123;&#123; 15|random(start&#x3D;4,step&#x3D;3) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        # 从0到15随机返回一个数字，步长为4</span><br><span class="line">        msg: &quot;&#123;&#123; 15|random(step&#x3D;4) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>


<h4 id="4-列表操作相关的过滤器"><a href="#4-列表操作相关的过滤器" class="headerlink" title="4. 列表操作相关的过滤器"></a>4. 列表操作相关的过滤器</h4><ul>
<li>length: 返回列表长度</li>
<li>first：返回列表的第一个值</li>
<li>last：返回列表的最后一个值</li>
<li>min：返回列表中最小的值</li>
<li>max：返回列表中最大的值</li>
<li>sort：重新排列列表，默认为升序排列，sort(reverse=true)为降序</li>
<li>sum：返回纯数字非嵌套列表中所有数字的和</li>
<li>flatten：如果列表中包含列表，则flatten可拉平嵌套的列表,levels参数可用于指定被拉平的层级</li>
<li>join：将列表中的元素合并为一个字符串</li>
<li>random：从列表中随机返回一个元素</li>
<li>shuffle</li>
<li>upper</li>
<li>lower</li>
<li>union：将两个列表合并，如果元素有重复，则只留下一个</li>
<li>intersect：获取两个列表的交集</li>
<li>difference：获取存在于第一个列表中，但不存在于第二个列表中的元素</li>
<li>symmetric_difference：取出两个列表中各自独立的元素，如果重复则只留一个</li>
</ul>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  gather_facts: false</span><br><span class="line">  vars:</span><br><span class="line">    testlist1: [1,2,4,6,3,5]</span><br><span class="line">    testlist2: [1,[2,3,4,[5,6]]]</span><br><span class="line">    testlist3: [1,2,&#39;a&#39;,&#39;b&#39;]</span><br><span class="line">    testlist4: [1,&#39;A&#39;,&#39;b&#39;,[&#39;C&#39;,&#39;d&#39;],&#39;Efg&#39;]</span><br><span class="line">    testlist5: [&#39;abc&#39;,1,2,&#39;a&#39;,3,2,&#39;1&#39;,&#39;abc&#39;]</span><br><span class="line">    testlist6: [&#39;abc&#39;,3,&#39;1&#39;,&#39;b&#39;,&#39;a&#39;]</span><br><span class="line">  tasks:</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 | length &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 |first &#125;&#125;&quot;</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 | last &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 | min &#125;&#125;&quot;</span><br><span class="line">    - debug: </span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 | max &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 | sort &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist1 | sort(reverse&#x3D;true) &#125;&#125;&quot;  </span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist2 | flatten &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist2 | flatten(levels&#x3D;1) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist2 | flatten | max &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist3 | join &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist3 |join(&#39;,&#39;)&#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist3 | random &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist3 | shuffle &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist4 | upper &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist4 | lower &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist5 | union(testlist6) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist5 | intersect(testlist6) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist5 | difference(testlist6) &#125;&#125;&quot;</span><br><span class="line">    - debug:</span><br><span class="line">        msg: &quot;&#123;&#123; testlist5 | symmetric_difference(testlist6) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="5-应用于注册变量的过滤器"><a href="#5-应用于注册变量的过滤器" class="headerlink" title="5. 应用于注册变量的过滤器"></a>5. 应用于注册变量的过滤器</h4><p>正常情况下，当某个task执行失败的时候，ansible会中止运行。此时我们可以通过<code>ignore_errors</code>来捕获异常以让task继续往下执行。然后调用debug模块打印出出错时的内容，拿来错误结果后，主动失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- name: Run myprog</span><br><span class="line">  command: &#x2F;opt&#x2F;myprog</span><br><span class="line">  register: result</span><br><span class="line">  ignore_errors: True</span><br><span class="line">  </span><br><span class="line">- debug: </span><br><span class="line">    var: result</span><br><span class="line"></span><br><span class="line">- debug: </span><br><span class="line">    msg: &quot;Stop running the playbook if myprog failed&quot;</span><br><span class="line">  failed_when: result|failed</span><br></pre></td></tr></table></figure>

<p>任务返回值过滤器：</p>
<ul>
<li>failed： 如果注册变量的值是任务failed则返回True</li>
<li>changed: 如果注册变量的值是任务changed则返回True</li>
<li>success：如果注册变量的值是任务succeeded则返回True</li>
<li>skipped：如果注册变量的值是任务skipped则返回True</li>
</ul>
<blockquote>
<p>在ansible2.9中，该方式会被废弃，不推荐使用</p>
</blockquote>
<h4 id="6-应用于文件路径的过滤器"><a href="#6-应用于文件路径的过滤器" class="headerlink" title="6. 应用于文件路径的过滤器"></a>6. 应用于文件路径的过滤器</h4><ul>
<li>basename：返回文件路径中的文件名部分</li>
<li>dirname：返回文件路径中的目录部分</li>
<li>expanduser：将文件路径中的~替换为用户目录</li>
<li>realpath：处理符号链接后的文件实际路径</li>
</ul>
<p>下面是一个示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: test basename</span><br><span class="line">  hosts: test</span><br><span class="line">  vars:</span><br><span class="line">    homepage: &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy homepage</span><br><span class="line">      copy:</span><br><span class="line">        src: files&#x2F;index.html</span><br><span class="line">        dest: &#123;&#123; homepage &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过basename改写成如下方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: test basename</span><br><span class="line">  hosts: test</span><br><span class="line">  vars:</span><br><span class="line">    homepage: &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy homepage</span><br><span class="line">      copy:</span><br><span class="line">        src: files&#x2F;&#123;&#123; homepage | basename &#125;&#125;</span><br><span class="line">        dest: &#123;&#123; homepage &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-自定义过滤器"><a href="#7-自定义过滤器" class="headerlink" title="7. 自定义过滤器"></a>7. 自定义过滤器</h4><p>举个简单的例子，现在有一个playbook如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- name: test filter</span><br><span class="line">  hosts: test</span><br><span class="line">  vars:</span><br><span class="line">    domains: [&quot;www.example.com&quot;,&quot;example.com&quot;]</span><br><span class="line">  tasks:</span><br><span class="line">    template:</span><br><span class="line">      src: templates&#x2F;test.conf.j2</span><br><span class="line">      dest: &#x2F;tmp&#x2F;test.conf</span><br></pre></td></tr></table></figure>

<p>templates/test.conf.j2如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts &#x3D; [&#123;&#123; domains | join(&#39;,&#39;) &#125;&#125;]</span><br></pre></td></tr></table></figure>

<p>执行playbook后，在目标机上的test.conf如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts &#x3D; [www.example.com,example.com]</span><br></pre></td></tr></table></figure>
<p>现在如果希望目标机上的test.conf文件返回结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts &#x3D; [&quot;www.example.com&quot;,&quot;example.com&quot;]</span><br></pre></td></tr></table></figure>
<p>没有现成的过滤器来帮我们做这件事情。我们可以自己简单写一个surround_by_quote.py内容如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 定义过滤器执行的操作</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">surround_by_quote</span><span class="params">(a_list)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> [<span class="string">'"%s"'</span> % an_element <span class="keyword">for</span> an_element <span class="keyword">in</span> a_list]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterModule</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">filters</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'surround_by_quote'</span>: surround_by_quote&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要开启ansible.cfg的配置项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter_plugins     &#x3D; &#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;filter</span><br></pre></td></tr></table></figure>
<p>将刚刚编写的代码文件放入/usr/share/ansible/plugins/filter目录下，然后修改templates/test.conf.j2如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts &#x3D; [&#123;&#123; domains | join(&#39;,&#39;) |surround_by_quote &#125;&#125;]</span><br></pre></td></tr></table></figure>

<p>再次执行playbook，最后返回结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts &#x3D; [&quot;www.example.com&quot;,&quot;example.com&quot;]</span><br></pre></td></tr></table></figure>


<blockquote>
<p>关于jinja2更多用法参考：<a href="http://docs.jinkan.org/docs/jinja2/" target="_blank" rel="noopener">http://docs.jinkan.org/docs/jinja2/</a></p>
</blockquote>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">捐款或者加个好友呗！</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/donate/alipay-qrcode.jpg" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/donate/alipay-qrcode.jpg" alt="支付宝捐款" title="支付宝捐款"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/donate/qq.jpg" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/donate/qq.jpg" alt="QQ加友" title="QQ加友"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/donate/wechat.png" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/wc6/cdn@6.6/img/donate/wechat.png" alt="微信加友" title="微信加友"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>蝶影双双</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://wc6.github.io/2020/05/20/13.%20Ansible%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%8F%8AJinja2%E8%BF%87%E6%BB%A4%E5%99%A8/" title="13. Ansible文件管理模块及Jinja2过滤器">https://wc6.github.io/2020/05/20/13.%20Ansible%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%8F%8AJinja2%E8%BF%87%E6%BB%A4%E5%99%A8/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/05/20/12.%20Ansible%20Vault%E9%85%8D%E7%BD%AE%E5%8A%A0%E5%AF%86/" rel="prev" title="12. Ansible Vault配置加密"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">12. Ansible Vault配置加密</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/05/20/14.%20Ansible%20Playbook%20with_X%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5/" rel="next" title="14. Ansible Playbook with_X循环语句"><span class="post-nav-text">14. Ansible Playbook with_X循环语句</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>评论功能未开启，请跳转 GitHub Issues 评论。</span><br><span>如果有错误，欢迎在GitHub Issues 提出。</span><br><a class="hty-button hty-button--raised" id="github-issues" href="https://github.com/wc6/wc6.github.io/issues?q=is:issue+13. Ansible文件管理模块及Jinja2过滤器" target="_blank" rel="noopener">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 蝶影双双</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v4.2.1</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v0.7.0</span></div><div class="live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  window.setTimeout(blog_live_time, 1000);
  const start = new Date('2020-05-20T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script defer src="/js/search/index.js"></script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div><script defer src="/js/hexo-theme-yun.js"></script></body></html>